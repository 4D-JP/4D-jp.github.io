---
layout: fix
title: "QUICネットワークレイヤーについて"
date: 2023-04-26 08:00:00
categories: 仕様
tags: v20 network clientserver
---

[v20](https://blog.4d.com/ja-whats-new-in-4d-v20/)では，クライアント/サーバー通信テクノロジーのアップグレードが計画されています。次世代のネットワークレイヤーは，[現在公開中のベータ版](https://blog.4d.com/ja/4d-v20-beta-starts-today/)で試験的に有効にすることができ，v20 LTS（Long Time Support）の正式リリースでは全面的に無効化され，v20 Rバージョンで選択的に有効化できるようになります。その後，v21で標準のネットワークレイヤーが切り替わる予定です。

この記事では，次世代ネットワークレイヤーについて説明します。

#### ネットワークレイヤーの変遷

初期の4D Serverは，[ネットワークコンポーネント](https://library.4d-japan.com/REFERENCE/65/4D%20-%204DServer/NetComp65.pdf)をインストールすることにより，IPX/SPX・TCP/IP・ADSPいずれかのネットワークプロトコルで4D Clientから4D Serverに接続することができました。4D Client以外のアプリケーションから4D Serverに接続するための[4D Open](https://library.4d-japan.com/REFERENCE/65/Connectivity%20Plug%20Ins/4D%20Open/Open_for_4D65.pdf)も同じネットワークコンポーネントを使用します。その後，v2003ではプロトコルが[TCP/IPに一本化](https://library.4d-japan.com/REFERENCE/2004/4D_Open_for_4D_200x.pdf)され，本体に組み込まれたことにより，コンポーネントを別途インストールする必要がなくなりました。

#### 旧式ネットワークレイヤー

v11 SQLでは，Unicodeモードや同時接続クライアント数の増加といった課題に対応し，通信レイテンシーをできるだけ抑えるため，TCP/IPネットワークレイヤーが全面的に新しくなりました。この世代のネットワークレイヤーは，下記のような特徴を備えています。

* 小さなリクエストを頻繁に送信するのではなく，必要に応じてまとまったリクエストを送信するプロトコル
* クライアント/サーバー通信とデータ通信を分離
* デフォルトの設定で前者はポート番号`19813`，後者は`19814`
* 前者はコオペラティブティブプロセス，後者はプリエンプティブプロセス  

クライアントがサーバーに接続すると，通信用の主要なソケットを維持するための**アプリケーションプロセス** *Main process* がクライアントとサーバーの双方で作成されます。同じようにクライアントが新規プロセスを起動し，サーバーにアクセスしようとすると，適宜，サーバー側にもユーザープロセスが作成されます。終了したプロセスはTCP接続を再利用できるようにしばらくプールされますが，やがて破棄されます。なお，クライアントがサーバーに接続すると，サーバーからクライアントにメッセージを送信するための**クライアント管理プロセス** *Client manager process* も作成され，専用のソケットが開かれます。クライアントは内部タイマープロセス *Internal timer process* でこのソケットを定期的にチェックします。**アプリケーションサーバー**とは，ユーザー認証・リソース管理・ストアドプロシージャー・命名セレクション・セット・サーバー側プロセス変数に対するアクセス・サーバー管理・デザインモードのオブジェクトロックなど，全般的なクライアント/サーバー通信に使用されるプロセス群の総称です。

今では旧式ネットワークレイヤーと呼ばれるこのテクノロジーは，従来のクライアント/サーバーと比較した場合，TCP/IPパケットの量が多く，通信の頻度が少なくなる傾向にあります。細かい設定は，[データベースパラメーター](https://doc.4d.com/4Dv19/4D/19.6/SET-DATABASE-PARAMETER.301-6270038.ja.html)つまりデータベース設定で調整することができます。特に重要なのはクライアント/サーバーの接続タイムアウトです。

* 4D Server Timeout (13)
* 4D Remote mode timeout (14)   

クライアントは，タイムアウトの`1/3`が経過するたび，いわゆる *ping* を送信します。サーバーとの通信に失敗した場合，ネットワーク接続に障害が発生したものと判断し，エラーが返されます。

上記のタイムアウトはクライアント/サーバーアプリケーションの通信つまりポート番号`19813`に適用されます。データアクセスには適用されません。`19814`ポートのソケットは常に開かれた状態であることが前提なので，ルーター機器などが無活動のソケットを閉じるようになっている場合，しばらくのアイドル時間を経てからクライアントがサーバーのデータベース（DB4DまたはSQL）にアクセスした場合，エラーが返される恐れがありました。アイドル時間タイムアウトは，データベースパラメーターで調整することができます。

* Idle connections timeout (54)  

#### 新ネットワークレイヤー

v15では，旧式ネットワークレイヤーの弱点を克服し，[スリープ検出](https://blog.4d.com/ja/application-sleep-notification/)や[シングル・サイン・オン](https://blog.4d.com/ja/single-sign-on-sso/)（クライアントはログイン画面を表示せず，Windowsのログインアカウントでサーバーに接続する）といった要望に応えるため，改良されたTCP/IPネットワークレイヤーが利用できるようになりました。**ServerNet**とも呼ばれる新ネットワークレイヤーを有効にすると，さまざまな先進的な機能が利用できるようになります。

* クライアント側でプリエンプティブプロセスを起動する
* [IPv6](https://doc.4d.com/4Dv19R7/4D/19-R7/IP-Settings.300-6078956.ja.html)アドレス
* [ABORT PROCESS BY ID](https://doc.4d.com/4Dv19R7/4D/19-R7/ABORT-PROCESS-BY-ID.301-5945356.ja.html)  

新ネットワークレイヤーには，前述したクライアント/サーバーの接続タイムアウトは設定値に関係なく，「なし」となります。

**ServerNet**とも呼ばれる新ネットワークレイヤーは，当初，Mac 64-bit版では必須，Windows 32-bit版では任意のデータベース設定でしたが，v17以降，Mac 64-bit版でも旧式ネットワークレイヤーが選択できるようになりました。

* Use legacy network layer (87)  

#### 新ネットワークレイヤーが作られた経緯

旧式ネットワークレイヤーは豊富な実績があり，長年，世界中の4D Serverで使われてきましたが，`1`個の接続に要するスレッド数が多く，全体として多くのメモリを消費する設計でした。たとえば，サーバー側で`1000`プロセスを管理するためには`4000`以上のスレッドが必要です。コンテキストを切り替えたり，メモリを確保したり，スレッドを作成したりするたびに多少の遅延が発生します。特にv11からv13のMac版は32-bitアプリケーションゆえに利用できるメモリが限られていたため，サーバー側のプロセススタックを少しでも節約できるよう，データベースパラメーターが用意されました。

* Server base process stack size (53)  

旧式ネットワークレイヤーは長年の保守によって高度に複雑化し，大規模なシステムだけで発生するような特殊な現象を調査することが困難な状況になりつつあったので，v14のRバージョンではすっきりした設計の新ネットワークレイヤーが開発され，漸進的に改良されてきました。

新ネットワークレイヤーは，軽量かつ高性能を目指して開発されましたが，処理の内容次第では，旧式ネットワークレイヤーのほうがパフォーマンス面で優れていることがあります。とはいえ，旧式ネットワークレイヤーよりも詳細な診断ログを記録するように作られていることも手伝って，バージョンを追うごとに安定性と速度が向上し，v19のRバージョンでは，非常に高い完成度に到達しました。

* Diagnostic log recording (79)
* Diagnostic log level (86)  

では，なぜ再びネットワークレイヤーを見直すことになったのか，と疑問に思うかもしれません。

#### QUIC

上述したように，4Dのネットワークレイヤーは，初代（v3からv2004）・旧式（v11からv15）・ServerNet（v15からv19）いずれもTCP/IPプロトコルをベースに4Dが独自に開発したものです。一方，業界ではTCPを使用しない，QUICが注目を集めています。

<i class="fa fa-external-link" aria-hidden="true"></i> [QUIC](https://ja.wikipedia.org/wiki/QUIC)

4Dデベロッパーの頭を悩ませてきたエラー（ヌル終点・接続エラーなど）のほとんどは，TCPソケットの仕様と切り離せないものです。そのため，不安定なネットワーク環境でも簡単には切れないクライアント/サーバー環境を構築するために実績の豊富なQUICが4Dのネットワークレイヤーに採用されることになりました。ServerNetと同じように，段階的に改良を重ねられるよう，移行期間が設けられます。

QUICはネットワーク障害に強く，TLS 1.3以上の暗号化で保護されていながら，効率的で高速である，という特徴を有しています。これまでのように4D側で複数のポート番号と多数のソケットを開いたままにして使いわけるのではなく，単一のUDPポート（やはり`19813`）を介してすべての通信をするというシンプルな設計も魅力です。v20のベータ版ではQUICネットワークレイヤーをプレビューすることができますが，運用では安定したServerNetを使用することが推奨されています。v20のLTSでQUICが無効化されるのはそのためです。QUICネットワークレイヤーは，v20のR3ないしR5から利用できるようになる見込みです。

**関連記事**: 

<i class="fa fa-external-link" aria-hidden="true"></i> [V20 QUIC network layer: a successor to the "New" Network layer](https://discuss.4d.com/t/v20-quic-network-layer-a-successor-to-the-new-network-layer/27286)

<i class="fa fa-external-link" aria-hidden="true"></i> [QUIC network layer will be opened during the beta of v20](https://discuss.4d.com/t/newfeature-quic-network-layer-will-be-opened-during-the-beta-of-v20/27294)
